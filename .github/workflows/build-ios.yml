name: Build and Release iOS XCFramework (Apuntes)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  version: 2.0

jobs:
  build-ios:
    name: Build shared iOS XCFramework
    runs-on: macos-latest  # or use 'self-hosted' if you have your own runner

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: âš™ï¸ Set up Gradle
        uses: gradle/gradle-build-action@v3

      - name: ğŸ”‘ Grant execute permission to Gradle wrapper
        run: chmod +x ./gradlew

      - name: ğŸ—ï¸ Build iOS XCFramework
        run: ./gradlew :shared:createXCFramework --stacktrace

      - name: ğŸ“¦ Zip XCFramework output
        run: |
          cd shared/build/XCFrameworks
          zip -r sharedKit_v${{ env.version }}.xcframework.zip sharedKit.xcframework

      - name: â¬†ï¸ Upload XCFramework artifact
        uses: actions/upload-artifact@v4
        with:
          name: sharedKit_v${{ env.version }}
          path: shared/build/XCFrameworks/sharedKit_v${{ env.version }}.xcframework.zip

      - name: ğŸ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.version }}
          name: "Apuntes SharedKit v${{ env.version }}"
          body: |
            âœ… iOS XCFramework for Apuntes v${{ env.version }} built successfully.
            You can download and integrate it into your Xcode project.
          files: shared/build/XCFrameworks/sharedKit_v${{ env.version }}.xcframework.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
