name: ğŸ“¦ Build & Release XCFramework

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  JAVA_VERSION: 17
  next_version: v1.0

jobs:
  build:
    name: ğŸ—ï¸ Build Shared Module
    runs-on: macos-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Setup JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: âš™ï¸ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ§± Prebuild iOS targets
        run: |
          ./gradlew :shared:compileKotlinIosArm64
          ./gradlew :shared:compileKotlinIosSimulatorArm64

      - name: ğŸ—ï¸ Build XCFramework
        run: ./gradlew :shared:assembleSharedKitXCFramework --stacktrace

      - name: ğŸ“¦ Locate and zip XCFramework output
        shell: bash
        run: |
          echo "ğŸ” Searching for .xcframework inside shared/build..."
          FRAMEWORK_PATH=$(find shared/build -type d -name "*.xcframework" | head -n 1)
          echo "ğŸ“ Found at: $FRAMEWORK_PATH"
          if [ -z "$FRAMEWORK_PATH" ]; then
            echo "âŒ XCFramework not found. Build may have failed."
            exit 1
          fi
          ZIP_NAME="sharedKit_${{ env.next_version }}.xcframework.zip"
          mkdir -p shared/build/XCFrameworks
          zip -r "shared/build/XCFrameworks/$ZIP_NAME" "$FRAMEWORK_PATH"
          echo "âœ… Created: shared/build/XCFrameworks/$ZIP_NAME"

      - name: ğŸ’¾ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sharedKit_${{ env.next_version }}
          path: shared/build/XCFrameworks/*.zip

  release:
    name: ğŸš€ Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“‚ Download built artifacts
        uses: actions/download-artifact@v4
        with:
          name: sharedKit_${{ env.next_version }}
          path: ./release

      - name: ğŸ§¾ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.next_version }}
          name: "SharedKit ${{ env.next_version }}"
          body: |
            ğŸš€ SharedKit KMP XCFramework build for iOS & Android.
            - Includes iOS Arm64 and Simulator binaries
            - Built automatically on push to **main**
          files: ./release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
