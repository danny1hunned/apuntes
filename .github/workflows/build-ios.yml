name: ğŸš€ Auto Build & Release iOS XCFramework (Apuntes)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    name: Build & Release XCFramework
    runs-on: macos-latest  # change to 'self-hosted' if using your own runner

    steps:
      # ğŸ§© Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # â˜• JDK for Gradle
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # âš™ï¸ Gradle setup
      - name: Set up Gradle
        uses: gradle/gradle-build-action@v3

      # ğŸ§¾ Make Gradle wrapper executable
      - name: Grant execute permission to Gradle wrapper
        run: chmod +x ./gradlew

      # ğŸ·ï¸ Determine next version number (auto-increment)
      - name: Get next version tag
        id: versioning
        run: |
          last_tag=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+$' | head -n 1)
          if [ -z "$last_tag" ]; then
            next_version="v1.0"
          else
            major=$(echo $last_tag | cut -d'.' -f1 | tr -d 'v')
            minor=$(echo $last_tag | cut -d'.' -f2)
            next_minor=$((minor + 1))
            next_version="v${major}.${next_minor}"
          fi
          echo "next_version=$next_version" >> $GITHUB_ENV
          echo "Next version: $next_version"

      # ğŸ—ï¸ Build XCFramework
      - name: Build shared XCFramework
        run: ./gradlew :shared:createXCFramework --stacktrace

      # ğŸ“¦ Zip the XCFramework output
      - name: Zip XCFramework output
        run: |
          cd shared/build/XCFrameworks
          zip -r sharedKit_${{ env.next_version }}.xcframework.zip sharedKit.xcframework

      # â¬†ï¸ Upload as a workflow artifact
      - name: Upload XCFramework artifact
        uses: actions/upload-artifact@v4
        with:
          name: sharedKit_${{ env.next_version }}
          path: shared/build/XCFrameworks/sharedKit_${{ env.next_version }}.xcframework.zip

      # ğŸ Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.next_version }}
          name: "Apuntes SharedKit ${{ env.next_version }}"
          body: |
            ğŸš€ Automatic build and release for Apuntes KMP SharedKit  
            âœ… Version: **${{ env.next_version }}**
            âœ… Built automatically via CI  
            âœ… Ready for integration into Xcode  
          files: shared/build/XCFrameworks/sharedKit_${{ env.next_version }}.xcframework.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
